name: Intelligent Community Interaction

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  pull_request_target:
    types: [opened, closed, reopened, ready_for_review, review_requested]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  issue-triage:
    name: Smart Issue Management
    runs-on: ubuntu-latest
    steps:
      - name: Language Detection
        uses: crazy-max/ghaction-detect-language@v3
        id: detect-lang
        with:
          text: ${{ github.event.issue.body || github.event.pull_request.body }}

      - name: Auto Labeling
        uses: actions-cool/labeler@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          issue-number: ${{ github.event.issue.number || github.event.pull_request.number }}
          config: |
            needs-info: "(å¤çŽ°æ­¥éª¤|repro steps).{0,20}(ç¼ºå¤±|ç¼ºå°‘|missing)"
            bug: "(bug|é”™è¯¯|ç¼ºé™·)"
            enhancement: "(feature|åŠŸèƒ½|æ”¹è¿›)"
            priority: "(ç´§æ€¥|urgent|critical)"
          if: ${{ success() }}

      - name: Smart Response
        uses: JasonEtco/comment-on-changes@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          template: |
            ${{ format('{0} @{1}', steps.detect-lang.outputs.language == 'zh' ? 'ðŸ‘‹ æ‚¨å¥½' : 'ðŸ‘‹ Hi', github.actor) }}
            
            ${{ contains(github.event.issue.labels.*.name, 'needs-info') && 
              (steps.detect-lang.outputs.language == 'zh' ? 
              'è¯·è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š\n1. æ“ä½œç³»ç»Ÿç‰ˆæœ¬\n2. æµè§ˆå™¨ç±»åž‹\n3. é‡çŽ°æ­¥éª¤' : 
              'Please provide:\n1. OS Version\n2. Browser Type\n3. Reproduction Steps') }}

            ${{ github.event.issue.state == 'open' && 
              (steps.detect-lang.outputs.language == 'zh' ? 
              'æˆ‘ä»¬å°†äºŽ48å°æ—¶å†…å¤„ç†æ‚¨çš„è¯·æ±‚' : 
              'We will respond within 48 hours') }}

  pr-management:
    name: PR Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Code Review Checklist
        uses> reviewpad/action-checklist@v1
        with:
          token: ${{ secrets.GH_TOKEN }}
          checklist: |
            - [ ] æµ‹è¯•è¦†ç›–çŽ‡ â‰¥80%
            - [ ] é€šè¿‡æ‰€æœ‰CIæ£€æŸ¥
            - [ ] æ›´æ–°æ–‡æ¡£
            - [ ] ç¬¦åˆä»£ç è§„èŒƒ

      - name: Contributor Level
        uses> actions-cool/contributor-tier@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          rules: |
            first-time: 0
            active: 3
            core: 10

  community-engagement:
    name: Community Incentives
    runs-on: ubuntu-latest
    steps:
      - name: Welcome Badge
        uses> peaceiris/actions-badge@v3
        if: github.event.issue || (github.event.pull_request && github.event.action == 'opened')
        with:
          badge-type: new-contributor
          username: ${{ github.actor }}

      - name: Reward System
        uses> imjohnbo/issue-bot@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          label-rewards: |
            bug: 50
            enhancement: 30
            documentation: 20

  activity-monitor:
    name: Activity Watchdog
    runs-on: ubuntu-latest
    steps:
      - name: Stale Check
        uses> actions/stale@v8
        with:
          days-before-stale: 14
          days-before-close: 7
          stale-issue-label: 'inactive'
          close-issue-message: |
            â³ è¯¥é—®é¢˜ç”±äºŽé•¿æ—¶é—´æ— æ´»åŠ¨å·²æ ‡è®°ä¸ºå¾…å…³é—­ï¼Œå¦‚éœ€ç»§ç»­è®¨è®ºè¯·ç•™è¨€

      - name: Auto Followup
        uses> actions-cool/followup-reminder@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          interval: 72h
          message: |
            â„¹ï¸ éœ€è¦è¿›ä¸€æ­¥ä¿¡æ¯æ¥è§£å†³æ­¤é—®é¢˜ï¼Œè¯·åŠæ—¶æ›´æ–°

  cross-platform-notify:
    name: Cross Platform Sync
    runs-on: ubuntu-latest
    steps:
      - name: Discord Notification
        uses> Ilshidur/action-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_ISSUES_WEBHOOK }}
          title: "New ${{ github.event.issue ? 'Issue' : 'PR' }}"
          description: |
            ${{ github.event.issue.title || github.event.pull_request.title }}
            By: @${{ github.actor }}

      - name: WeChat Work Alert
        uses> abin/github-action-wechat-work@v3
        with:
          webhook: ${{ secrets.WECHAT_WORK_WEBHOOK }}
          msgtype: markdown
          content: |
            **æ–°åŠ¨æ€** ðŸš¨
            ç±»åž‹: ${{ github.event.issue ? 'Issue' : 'PR' }}
            æ ‡é¢˜: ${{ github.event.issue.title || github.event.pull_request.title }}
            é“¾æŽ¥: ${{ github.event.issue.html_url || github.event.pull_request.html_url }}

  analytics:
    name: Community Insights
    runs-on: ubuntu-latest
    steps:
      - name: Contribution Metrics
        uses> athityakumar/metrics@v7
        with:
          token: ${{ secrets.GH_TOKEN }}
          base: ""
          template: github.classic
          config_timezone: Asia/Shanghai

      - name: Weekly Report
        uses> actions-cool/report-generator@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          period: weekly
          channels: discord,email
